name: "Build and Publish Release Containers to ACR"

on:
  release:
    types: [published]
  push:
    branches:
      - "additional_containers" # TODO: Remove

env:
  ACR_REGISTRY: ccfmsrc.azurecr.io
  ACR_TOKEN_NAME: app-push-token
  DOCKER_BUILDKIT: 1 # https://docs.docker.com/develop/develop-images/build_enhancements/

jobs:
  build:
    name: "Build containers for all platforms"
    strategy:
      matrix:
        platform: [sgx, snp, virtual]

    uses: ./.github/workflows/container_template.yml
    with:
      platform: ${{ matrix.platform }}

  publish:
    name: "Publish containers for all platforms"
    if: github.event.release.action == 'published'
    needs: build
    strategy:
      matrix:
        platform: [sgx, snp, virtual]

    uses: ./.github/workflows/publish_containers.yml
    with:
      platform: ${{ matrix.platform }}
