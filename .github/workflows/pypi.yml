name: "Build and Publish PyPi package"

on:
  release:
    types: [published]
  push:
    branches:
      - "fix_containers_pypi"

jobs:
  build_and_publish:
    name: "Publish ccf package to PyPi"
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3

      - name: Get release number from git tag (release) or latest (branch)
        run: |
          echo "version=4.0.0-dev0" >> $GITHUB_OUTPUT
        id: tref

      - name: Fetch PyPi Package from release
        run: |
          cd python
          VERSION=${{steps.tref.outputs.version}}
          PYPY_VERSION=${VERSION//-}
          RELEASE_DETAILS=$(curl -s https://api.github.com/repos/microsoft/ccf/releases/tags/ccf-${VERSION})
          echo ${{ fromJson(${RELEASE_DETAILS}) }}
          wget https://github.com/microsoft/CCF/releases/download/ccf-${VERSION}/ccf-${PYPY_VERSION}-py3-none-any.whl

      # - name: Publish PyPi Package to https://pypi.org/project/ccf/
      #   run: |
      #     set -ex
      #     cd python
      #     python3.8 -m venv env
      #     source ./env/bin/activate
      #     pip install -r requirements.txt
      #     pip install twine
      #     twine upload -u __token__ -p ${{ secrets.PYPI_TOKEN }} *.whl
