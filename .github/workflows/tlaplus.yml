name: "TLA+ Spec Verification"

on:
  push:
    paths:
      - "tla/**"
  pull_request:
    paths:
      - "tla/**"
  workflow_dispatch:

jobs:
  model-checking-consensus:
    name: Model Checking - Consensus
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: python ./tla/install_deps.py

      - name: MCccfraft.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto MCccfraft.tla 2>&1 | tee MCccfraft.out

      - name: MCccfraftWithReconfig.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config MCccfraftWithReconfig.cfg MCccfraft.tla 2>&1 | tee MCccfraftWithReconfig.out

      - name: Upload TLC's out file as an artifact. Can be imported into the TLA+ Toolbox.
        uses: actions/upload-artifact@v2
        if: ${{ failure() }}
        with:
          name: tlc
          path: tla/*.out

  simulation-consensus:
    name: Simulation - Consensus
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: python ./tla/install_deps.py

      - name: SIMccfraft.tla
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -simulate -depth 500 SIMccfraft.tla 2>&1 | tee SIMccfraft.out

      - name: Upload TLC's out file as an artifact. Can be imported into the TLA+ Toolbox.
        uses: actions/upload-artifact@v2
        if: ${{ failure() }}
        with:
          name: tlc
          path: tla/*.out

  model-checking-consistency:
    name: Model Checking - Consistency
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: python ./tla/install_deps.py

      - name: consistency/MCSingleNode.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config consistency/MCSingleNode.cfg consistency/MCSingleNode.tla 2>&1 | tee consistency/MCSingleNode.out

      - name: consistency/MCSingleNodeReads.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config consistency/MCSingleNodeReads.cfg consistency/MCSingleNodeReads.tla 2>&1 | tee consistency/MCSingleNodeReads.out

      - name: consistency/MCMultiNode.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config consistency/MCMultiNode.cfg consistency/MCMultiNode.tla 2>&1 | tee consistency/MCMultiNode.out

      - name: consistency/MCMultiNodeReads.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config consistency/MCMultiNodeReads.cfg consistency/MCMultiNodeReads.tla 2>&1 | tee consistency/MCMultiNodeReads.out

      - name: consistency/MCMultiNodeReadsAlt.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc.sh -workers auto -config consistency/MCMultiNodeReadsAlt.cfg consistency/MCMultiNodeReadsAlt.tla 2>&1 | tee consistency/MCMultiNodeReadsAlt.out

      - name: Upload TLC's out file as an artifact. Can be imported into the TLA+ Toolbox.
        uses: actions/upload-artifact@v2
        if: ${{ failure() }}
        with:
          name: tlc
          path: tla/consistency/*.out

  model-checking-counterexamples-consistency:
    name: Model Checking (Counterexamples) - Consistency
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v3
      - run: python ./tla/install_deps.py

      - name: consistency/MCSingleNodeCommitReachability.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc_debug.sh -workers auto -config consistency/MCSingleNodeCommitReachability.cfg consistency/MCSingleNodeReads.tla 2>&1 | tee consistency/MCSingleNodeReads.out

      - name: consistency/MCMultiNodeCommitReachability.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc_debug.sh -workers auto -config consistency/MCMultiNodeCommitReachability.cfg consistency/MCMultiNodeReads.tla 2>&1 | tee consistency/MCMultiNodeCommitReachability.out

      - name: consistency/MCMultiNodeInvalidReachability.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc_debug.sh -workers auto -config consistency/MCMultiNodeInvalidReachability.cfg consistency/MCMultiNodeReads.tla 2>&1 | tee consistency/MCMultiNodeInvalidReachability.out

      - name: consistency/MCMultiNodeReadsNotLinearizable.cfg
        run: |
          set -exo pipefail
          cd tla/
          ./tlc_debug.sh -workers auto -config consistency/MCMultiNodeReadsNotLinearizable.cfg consistency/MCMultiNodeReads.tla 2>&1 | tee consistency/MCMultiNodeReadsNotLinearizable.out

      - name: Upload TLC's out file as an artifact. Can be imported into the TLA+ Toolbox.
        uses: actions/upload-artifact@v2
        if: ${{ failure() }}
        with:
          name: tlc
          path: tla/consistency/*.out
