# Re-usable workflow for per-platform container build

on:
  workflow_call:
    inputs:
      platform:
        required: true
        type: string

env:
  ACR_REGISTRY: ccfmsrc.azurecr.io

jobs:
  build_containers:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2

      - name: Get image tag from git tag (release)
        run: echo "##[set-output name=tag;]2.0.8" # echo "##[set-output name=tag;]${GITHUB_REF#refs/tags/ccf-}" TODO: Revert
        id: tref

      - name: Build App Dev ${{ inputs.platform }} container
        run: docker build -f docker/app_dev . --build-arg="platform=${{ inputs.platform }}" --build-arg="ansible_vars=ccf_ver=${{ steps.tref.outputs.tag }}" -t $ACR_REGISTRY/public/ccf/app/dev:${{ steps.tref.outputs.tag }}-${{ inputs.platform }} -t  $ACR_REGISTRY/public/ccf/app/dev:lts-devcontainer-${{ inputs.platform }}

      - name: Build App Run ${{ inputs.platform }} container
        run: docker build -f docker/app_run . --build-arg="platform=${{ inputs.platform }}" --build-arg="ansible_vars=ccf_ver=${{steps.tref.outputs.tag}}" -t $ACR_REGISTRY/public/ccf/app/run:${{steps.tref.outputs.tag}}-${{ inputs.platform }}

      - name: Build JS App Run ${{ inputs.platform }} container
        run: docker build -f docker/app_run . --build-arg="platform=${{ inputs.platform }}" --build-arg="ansible_vars=ccf_ver=${{steps.tref.outputs.tag}}  run_js=true" -t $ACR_REGISTRY/public/ccf/app/run-js:${{steps.tref.outputs.tag}}-${{ inputs.platform }}
