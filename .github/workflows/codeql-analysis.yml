# For most projects, this workflow file will not need changing; you simply need
# to commit it to your repository.
#
# You may wish to alter this file to override the set of languages analyzed,
# or to provide custom queries or build logic.
name: "CodeQL"

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
    paths:
      - ".github/workflows/codeql-analysis.yml"
  workflow_dispatch:

permissions: read-all

jobs:
  analyze:
    name: Analyze
    # Insufficient space to run on public runner, so use custom pool
    runs-on: [self-hosted, 1ES.Pool=gha-virtual-ccf-sub]
    container:
      image: ccfmsrc.azurecr.io/ccf/ci:2024-06-26-virtual-clang15
      options: --user root

    permissions:
      security-events: write

    strategy:
      fail-fast: false
      matrix:
        language: ["cpp"]

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: ${{ matrix.language }}
          queries: security-extended

      - run: |
          set -ex
          git config --global --add safe.directory /__w/CCF/CCF
          ls build
          mkdir build
          cd build
          cmake -DCOMPILE_TARGET=virtual -DREQUIRE_OPENENCLAVE=OFF -DCMAKE_BUILD_TYPE=Debug -DBUILD_TESTS=OFF -DLVI_MITIGATIONS=OFF ..
        name: Run CMake

      - run: |
          cd build
          make
        name: Run Make

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
