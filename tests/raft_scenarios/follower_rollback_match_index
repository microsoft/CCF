# A repro of the failing scenario where a follower rolls back its ledger by becoming a pre-vote-candidate and then back to a follower (#7618)
# If this follower had previously acked an append-entries, then the leader's matchIdx for it would be higher than its truncated ledger.
# This was fixed by no longer rolling back uncommittable entries (no signature) when becoming a follower.

start_node,0
emit_signature,2
assert_commit_idx,0,2

swap_nodes,2,in,1,2
emit_signature,2

loop_until_sync

replicate,2,tx1

# advance matchIdx
periodic_one,0,10
dispatch_single,0,2
dispatch_single,2,0

emit_signature,2

# time out b2
periodic_one,2,100
assert_detail,2,leadership_state,PreVoteCandidate
drop_pending_to,2,0 # Drop pre-vote request

periodic_one,0,10
dispatch_single,0,2
dispatch_single,2,0

periodic_one,0,10 
dispatch_single,0,2
dispatch_single,2,0

state_all
