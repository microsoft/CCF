start_node,0
emit_signature,2
swap_nodes,2,in,1,2
emit_signature,2

periodic_one,0,10
dispatch_all
periodic_one,0,10
dispatch_all
periodic_one,0,10
dispatch_all

# All nodes just have config {0,1,2}
assert_commit_idx,0,4
assert_absent_config,0,1
assert_config,0,3,0,1,2

assert_commit_idx,1,4
assert_absent_config,1,1
assert_config,1,3,0,1,2

assert_commit_idx,2,4
assert_absent_config,2,1
assert_config,2,3,0,1,2

# Node 1 steps up as a pre-vote candidate
periodic_one,1,100
assert_detail,1,leadership_state,PreVoteCandidate

# Node 2 responds to pre-vote request, 
# but does not update its term
dispatch_single,1,2
assert_detail,2,leadership_state,Follower
assert_detail,2,current_view,2

# Node 1 becomes candidate and then leader for term 3
dispatch_single,2,1
assert_detail,1,leadership_state,Candidate
assert_detail,1,current_view,3
dispatch_single,1,2
dispatch_single,2,1
assert_detail,1,leadership_state,Leader

# Node 0 is unable to become a candidate
# Node 0 steps down via CheckQuorum
periodic_one,0,100
assert_detail,0,leadership_state,Follower
periodic_one,0,100
assert_detail,0,leadership_state,PreVoteCandidate
assert_detail,0,current_view,2

# Upon receiving AppendEntries from Node 1,
# Node 0 becomes a follower in view 3
dispatch_single,1,0
dispatch_single,1,0
assert_detail,0,current_view,3
assert_detail,0,leadership_state,Follower

dispatch_all
periodic_one,0,10
dispatch_all

assert_commit_idx,0,4
assert_detail,0,current_view,3
assert_commit_idx,1,4
assert_detail,1,current_view,3
assert_commit_idx,2,4
assert_detail,2,current_view,3

# PreVotes can be denied if they are from an older log
emit_signature,3
periodic_one,1,10
dispatch_single,1,2

# Node 0 becomes a prevote candidate but cannot be elected
periodic_one,0,100
assert_detail,0,leadership_state,PreVoteCandidate
assert_detail,0,current_view,3
summarise_log,0
# n[0]: 2.1, 2.2, 2.3, [2.4] (ts=351)
assert_detail,2,leadership_state,Follower
summarise_log,2
# n[2]: 2.1, 2.2, 2.3, [2.4], 3.5 (ts=351)

dispatch_single,0,2
dispatch_single,2,0

# Node 0 is still a PreVoteCandidate as Node 2 denied its pre-vote request
assert_detail,0,leadership_state,PreVoteCandidate

# Node 0 will fall back to a follower when it receives an append entries
dispatch_single,1,0
assert_detail,0,leadership_state,Follower