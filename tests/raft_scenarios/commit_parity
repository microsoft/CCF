# Fully-connected 3-node network
nodes,0,1,2
connect,0,1
connect,1,2
connect,0,2

# Node 0 calls and wins election
periodic_one,0,110
dispatch_all

periodic_all,10
dispatch_all
assert_is_primary,0

# Node 0 creates entry and a signature...
replicate,1,AA
emit_signature,1

# ...sends this to both backups...
periodic_all,10
dispatch_all_once

# ...receives ACK responses (advancing commit)...
periodic_all,10
dispatch_all_once
assert_commit_safety,0

# ...but only reports this commit to node 1
periodic_all,10
drop_pending_to,0,2
dispatch_all_once
assert_commit_safety,1

# Node 2 calls an election...
periodic_one,2,110
dispatch_all

# And wins (changing its opinion of committable indices!)
periodic_all,10
dispatch_all
assert_is_primary,2

# Before node 2 can advance commit, node 0 wins an election
periodic_one,0,110
dispatch_all

periodic_all,10
dispatch_all
assert_is_primary,0

# Now node 2 will not update its commit index, and fully sync!
periodic_all,10
dispatch_all
periodic_all,10
dispatch_all
periodic_all,10
dispatch_all
periodic_all,10
dispatch_all

# Until node 0 produces a _new_ suffix, to advance commit over
replicate,3,BB
emit_signature,3
periodic_all,10
dispatch_all
periodic_all,10
dispatch_all

state_all
assert_state_sync
