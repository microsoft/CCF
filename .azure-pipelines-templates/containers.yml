jobs:
  - job: Release_Containers
    displayName: "Release Containers"

    ${{ insert }}: ${{ parameters.env }}

    steps:
      - checkout: self
        clean: true
        fetchDepth: 1

      - ${{ if startsWith(variables['Build.SourceBranch'], 'refs/tags/ccf-') }}:
        - script: |
            set -ex
            VERSION=${(Build.SourceBranch):"-refs/tags/ccf-"}
            echo "##vso[task.setvariable variable=release_version]$VERSION"
          displayName: "Retrieve Version"
      
      # Note: Version is hardcoded until 3.0.0 final is released as Debian package
      # naming scheme was changed for 3.x and latest still points to incompatible 2.x
      - ${{ if not(startsWith(variables['Build.SourceBranch'], 'refs/tags/ccf-')) }}:
        - script: |
            set -ex
            VERSION="3.0.0-rc0"
            echo "##vso[task.setvariable variable=release_version]$VERSION"
          displayName: "Retrieve Version"

      - script: | 
          set -ex 
          docker/build_release_images.sh ccfmsrc.azurecr.io $(release_version)
        displayName: "Build Release Containers"
