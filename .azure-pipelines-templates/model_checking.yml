jobs:
  - job: Model_Checking
    displayName: "Model Checking"
    variables:
      Codeql.SkipTaskAutoInjection: true
      skipComponentGovernanceDetection: true
    timeoutInMinutes: 360

    ${{ insert }}: ${{ parameters.env }}

    steps:
      - checkout: self
        clean: true
        fetchDepth: 1

      - script: |
          set -ex
          sudo apt update
          sudo apt install -y default-jre
          python3 ./tla/install_deps.py
        displayName: Setup

      - script: ./tlc.sh -workers auto consensus/MCccfraft.tla -dumpTrace tla MCccfraft.trace.tla -dumpTrace json MCccfraft.json
        workingDirectory: tla
        displayName: MCccfraft.cfg

      - script: ./tlc.sh -workers auto -config consensus/MCccfraftAtomicReconfig.cfg consensus/MCccfraft.tla -dumpTrace tla MCccfraftAtomicReconfig.trace.tla -dumpTrace json MCccfraftAtomicReconfig.json
        workingDirectory: tla
        displayName: MCccfraftAtomicReconfig.cfg
        condition: ne(variables['Build.CronSchedule.DisplayName'], 'Daily build')

      - script: ./tlc.sh -workers auto -config consensus/MCccfraftWithReconfig.cfg consensus/MCccfraft.tla -dumpTrace tla MCccfraftWithReconfig.trace.tla -dumpTrace json MCccfraftWithReconfig.json
        workingDirectory: tla
        displayName: MCccfraftWithReconfig.cfg
        condition: ne(variables['Build.CronSchedule.DisplayName'], 'Daily build')

      - script: ./tlc.sh -workers auto -config consensus/MCccfraftAtomicReconfig.cfg consensus/MCccfraft.tla -dumpTrace tla MCccfraftAtomicReconfig.trace.tla -dumpTrace json MCccfraftAtomicReconfig.json -coverage 1 -nowarning
        workingDirectory: tla
        displayName: MCccfraftAtomicReconfig.cfg
        condition: eq(variables['Build.CronSchedule.DisplayName'], 'Daily build')

      - script: ./tlc.sh -workers auto -config consensus/MCccfraftWithReconfig.cfg consensus/MCccfraft.tla -dumpTrace tla MCccfraftWithReconfig.trace.tla -dumpTrace json MCccfraftWithReconfig.json -coverage 1 -nowarning
        workingDirectory: tla
        displayName: MCccfraftWithReconfig.cfg
        condition: eq(variables['Build.CronSchedule.DisplayName'], 'Daily build')

      - script: |
          set -ex
          python3 -mvenv env
          source env/bin/activate
          pip install -r requirements.txt
          ls -tr MCccfraftAtomicReconfig_coverage_*.json | xargs cat | python3 actions.py MCccfraftAtomicReconfig.html
          rm MCccfraftAtomicReconfig_coverage_*.json
          ls -tr MCccfraftWithReconfig_coverage_*.json | xargs cat | python3 actions.py MCccfraftWithReconfig.html
          rm MCccfraftWithReconfig_coverage_*.json
          deactivate
          rm -rf env
        workingDirectory: tla
        condition: eq(variables['Build.CronSchedule.DisplayName'], 'Daily build')

      - task: PublishPipelineArtifact@1
        inputs:
          artifactName: "Model Checking Traces"
          targetPath: tla
        condition: or(or(failed(), canceled()), eq(variables['Build.CronSchedule.DisplayName'], 'Daily build'))
